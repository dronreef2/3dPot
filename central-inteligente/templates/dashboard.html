<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3dPot - Central de Controle Inteligente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .status-success { border-left-color: #28a745; }
        .status-warning { border-left-color: #ffc107; }
        .status-danger { border-left-color: #dc3545; }
        .status-info { border-left-color: #17a2b8; }
        
        .metric-display {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        
        .control-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
        }
        
        .alert-item {
            border-left: 4px solid;
            margin-bottom: 10px;
        }
        
        .alert-info { border-left-color: #17a2b8; }
        .alert-warning { border-left-color: #ffc107; }
        .alert-error { border-left-color: #dc3545; }
        .alert-critical { border-left-color: #e83e8c; }
        
        .system-status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 5px;
        }
        
        .system-online { background-color: #d4edda; color: #155724; }
        .system-offline { background-color: #f8d7da; color: #721c24; }
        
        .production-controls {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .speed-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        @media (max-width: 768px) {
            .metric-display { font-size: 1.5rem; }
            .control-panel { margin-top: 20px; }
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center py-3">
                    <div>
                        <h1 class="mb-0"><i class="fas fa-cogs"></i> 3dPot Central</h1>
                        <p class="text-muted mb-0">Sistema de Controle Inteligente</p>
                    </div>
                    <div>
                        <span class="badge bg-success" id="connectionStatus">
                            <i class="fas fa-wifi"></i> Conectado
                        </span>
                        <span class="badge bg-info" id="lastUpdate">
                            <i class="fas fa-clock"></i> --
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="card-title text-muted">Peso do Filamento</h6>
                                <div class="metric-display" id="weightDisplay">0.0g</div>
                                <small class="text-muted">Mínimo: 100g</small>
                            </div>
                            <div>
                                <i class="fas fa-weight-hanging fa-2x text-muted"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="card-title text-muted">Velocidade Esteira</h6>
                                <div class="metric-display" id="conveyorDisplay">0</div>
                                <small class="text-muted">Pulsos/segundo</small>
                            </div>
                            <div>
                                <i class="fas fa-arrows-alt-h fa-2x text-muted"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="card-title text-muted">QC Status</h6>
                                <div class="metric-display" id="qcDisplay">Aguardando</div>
                                <small class="text-muted">Controle Qualidade</small>
                            </div>
                            <div>
                                <i class="fas fa-search fa-2x text-muted"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="card-title text-muted">Modo Atual</h6>
                                <div class="metric-display" id="modeDisplay">Ocioso</div>
                                <small class="text-muted" id="activeStatus">Sistema Inativo</small>
                            </div>
                            <div>
                                <i class="fas fa-play-circle fa-2x text-muted"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- System Status -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-server"></i> Status dos Sistemas</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="system-status" id="esp32Status">
                                    <strong><i class="fas fa-microchip"></i> ESP32 (Monitor)</strong>
                                    <br><span class="status-text">Verificando...</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="system-status" id="arduinoStatus">
                                    <strong><i class="fas fa-microchip"></i> Arduino (Esteira)</strong>
                                    <br><span class="status-text">Verificando...</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="system-status" id="rpiStatus">
                                    <strong><i class="fas fa-microchip"></i> RPi (QC)</strong>
                                    <br><span class="status-text">Verificando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Alertas</h5>
                    </div>
                    <div class="card-body" id="alertsContainer" style="max-height: 200px; overflow-y: auto;">
                        <div class="text-muted">Nenhum alerta ativo</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-sliders-h"></i> Controles de Produção</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="production-controls">
                                    <h6><i class="fas fa-play"></i> Controle Geral</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success" id="startProduction" disabled>
                                            <i class="fas fa-play"></i> Iniciar Produção
                                        </button>
                                        <button class="btn btn-danger" id="stopProduction" disabled>
                                            <i class="fas fa-stop"></i> Parar Produção
                                        </button>
                                        <button class="btn btn-info" id="startQC">
                                            <i class="fas fa-search"></i> Iniciar QC
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="production-controls">
                                    <h6><i class="fas fa-tachometer-alt"></i> Velocidade da Esteira</h6>
                                    <input type="range" class="speed-slider" id="speedSlider" 
                                           min="0" max="1000" value="50">
                                    <div class="d-flex justify-content-between">
                                        <small>0</small>
                                        <small>1000</small>
                                    </div>
                                    <div class="text-center">
                                        <strong>Atual: <span id="speedValue">50</span> pps</strong>
                                    </div>
                                    <button class="btn btn-primary btn-sm w-100 mt-2" id="applySpeed">
                                        <i class="fas fa-check"></i> Aplicar Velocidade
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="control-panel">
                    <h5><i class="fas fa-cog"></i> Monitoramento</h5>
                    <div class="mb-3">
                        <strong>Filamento Baixo:</strong>
                        <span class="badge bg-warning" id="filamentAlert" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i> Alerta Ativo
                        </span>
                        <span class="badge bg-success" id="filamentOK" style="display: none;">
                            <i class="fas fa-check"></i> OK
                        </span>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Ultima Atualização:</strong>
                        <div id="updateTime">--:--:--</div>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Tempo de Operação:</strong>
                        <div id="uptime">00:00:00</div>
                    </div>
                    
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar" id="progressBar" style="width: 0%">
                            <span id="progressText">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // Inicializar Socket.IO
        const socket = io();
        
        // Variáveis de estado
        let systemStatus = {};
        let lastUpdate = null;
        let startTime = Date.now();
        
        // Elementos DOM
        const elements = {
            weightDisplay: document.getElementById('weightDisplay'),
            conveyorDisplay: document.getElementById('conveyorDisplay'),
            qcDisplay: document.getElementById('qcDisplay'),
            modeDisplay: document.getElementById('modeDisplay'),
            activeStatus: document.getElementById('activeStatus'),
            esp32Status: document.getElementById('esp32Status'),
            arduinoStatus: document.getElementById('arduinoStatus'),
            rpiStatus: document.getElementById('rpiStatus'),
            alertsContainer: document.getElementById('alertsContainer'),
            startProduction: document.getElementById('startProduction'),
            stopProduction: document.getElementById('stopProduction'),
            startQC: document.getElementById('startQC'),
            speedSlider: document.getElementById('speedSlider'),
            speedValue: document.getElementById('speedValue'),
            applySpeed: document.getElementById('applySpeed'),
            filamentAlert: document.getElementById('filamentAlert'),
            filamentOK: document.getElementById('filamentOK'),
            lastUpdate: document.getElementById('lastUpdate'),
            updateTime: document.getElementById('updateTime'),
            uptime: document.getElementById('uptime'),
            progressBar: document.getElementById('progressBar'),
            progressText: document.getElementById('progressText')
        };
        
        // Atualizar display
        function updateDisplay(status) {
            systemStatus = status;
            lastUpdate = new Date();
            
            // Métricas principais
            elements.weightDisplay.textContent = `${status.weight?.toFixed(1) || 0.0}g`;
            elements.conveyorDisplay.textContent = status.conveyor_speed || 0;
            elements.qcDisplay.textContent = status.qc_status || 'Aguardando';
            elements.modeDisplay.textContent = getModeText(status.current_mode);
            elements.activeStatus.textContent = status.active ? 'Sistema Ativo' : 'Sistema Inativo';
            
            // Status de sistemas
            updateSystemStatus('esp32Status', status.esp32_status);
            updateSystemStatus('arduinoStatus', status.arduino_status);
            updateSystemStatus('rpiStatus', status.rpi_status);
            
            // Controles
            updateControls(status);
            
            // Alertas
            updateAlerts(status);
            
            // Timestamps
            updateTimestamps();
        }
        
        // Atualizar status de sistema individual
        function updateSystemStatus(elementId, status) {
            const element = elements[elementId];
            const statusText = element.querySelector('.status-text');
            
            if (status === 'ready' || status === 'connected') {
                element.className = 'system-status system-online';
                statusText.textContent = 'Online';
            } else if (status === 'error' || status === 'disconnected') {
                element.className = 'system-status system-offline';
                statusText.textContent = 'Offline';
            } else {
                element.className = 'system-status';
                statusText.textContent = 'Verificando...';
            }
        }
        
        // Atualizar controles
        function updateControls(status) {
            elements.startProduction.disabled = !status.ready_to_start;
            elements.stopProduction.disabled = !status.active;
        }
        
        // Atualizar alertas
        function updateAlerts(status) {
            if (status.filament_low) {
                elements.filamentAlert.style.display = 'inline-block';
                elements.filamentOK.style.display = 'none';
            } else {
                elements.filamentAlert.style.display = 'none';
                elements.filamentOK.style.display = 'inline-block';
            }
        }
        
        // Atualizar timestamps
        function updateTimestamps() {
            if (lastUpdate) {
                elements.lastUpdate.innerHTML = `<i class="fas fa-clock"></i> ${lastUpdate.toLocaleTimeString()}`;
                elements.updateTime.textContent = lastUpdate.toLocaleTimeString();
            }
            
            // Tempo de operação
            const uptime = Math.floor((Date.now() - startTime) / 1000);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = uptime % 60;
            elements.uptime.textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Progresso baseado no peso (exemplo)
            const weight = systemStatus.weight || 0;
            const progress = Math.min((weight / 1000) * 100, 100); // 1000g = 100%
            elements.progressBar.style.width = `${progress}%`;
            elements.progressText.textContent = `${progress.toFixed(0)}%`;
        }
        
        // Obter texto do modo
        function getModeText(mode) {
            const modes = {
                'idle': 'Ocioso',
                'monitoring': 'Monitorando',
                'quality_check': 'Controle Qualidade',
                'production': 'Produção'
            };
            return modes[mode] || 'Desconhecido';
        }
        
        // Event listeners
        elements.startProduction.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/start_production', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.success) {
                    showAlert('success', 'Produção iniciada com sucesso!');
                } else {
                    showAlert('danger', 'Erro ao iniciar produção: ' + result.message);
                }
            } catch (error) {
                showAlert('danger', 'Erro de conexão: ' + error.message);
            }
        });
        
        elements.stopProduction.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/stop_production', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.success) {
                    showAlert('info', 'Produção parada');
                }
            } catch (error) {
                showAlert('danger', 'Erro de conexão: ' + error.message);
            }
        });
        
        elements.startQC.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/start_qc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.success) {
                    showAlert('info', 'Controle de qualidade iniciado!');
                } else {
                    showAlert('warning', 'Erro ao iniciar QC: ' + result.message);
                }
            } catch (error) {
                showAlert('danger', 'Erro de conexão: ' + error.message);
            }
        });
        
        elements.speedSlider.addEventListener('input', (e) => {
            elements.speedValue.textContent = e.target.value;
        });
        
        elements.applySpeed.addEventListener('click', async () => {
            const speed = elements.speedSlider.value;
            try {
                const response = await fetch('/api/conveyor/speed', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ speed: parseInt(speed) })
                });
                const result = await response.json();
                if (result.success) {
                    showAlert('success', `Velocidade definida para ${speed} pps`);
                } else {
                    showAlert('warning', 'Erro ao definir velocidade');
                }
            } catch (error) {
                showAlert('danger', 'Erro de conexão: ' + error.message);
            }
        });
        
        // Socket.IO events
        socket.on('status_update', (data) => {
            updateDisplay(data);
        });
        
        socket.on('connect', () => {
            document.getElementById('connectionStatus').innerHTML = 
                '<i class="fas fa-wifi"></i> Conectado';
            document.getElementById('connectionStatus').className = 'badge bg-success';
        });
        
        socket.on('disconnect', () => {
            document.getElementById('connectionStatus').innerHTML = 
                '<i class="fas fa-wifi-slash"></i> Desconectado';
            document.getElementById('connectionStatus').className = 'badge bg-danger';
        });
        
        // Função para mostrar alertas
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Carregar status inicial
        async function loadInitialStatus() {
            try {
                const response = await fetch('/api/status');
                if (response.ok) {
                    const status = await response.json();
                    updateDisplay(status);
                }
            } catch (error) {
                console.error('Error loading initial status:', error);
            }
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialStatus();
            updateTimestamps();
        });
        
        // Atualizar timestamps a cada segundo
        setInterval(updateTimestamps, 1000);
    </script>
</body>
</html>