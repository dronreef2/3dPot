name: 3dPot CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Executa todos os dias às 08:00 UTC
    - cron: '0 8 * * *'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Validação básica de qualidade de código
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Instalar dependências de qualidade
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 mypy isort
          pip install -e .[dev]

      - name: Verificar formatação com Black
        run: |
          black --check --diff .
        continue-on-error: true

      - name: Verificar linting com Flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true

      - name: Verificar formatação com isort
        run: |
          isort --check-only --diff .
        continue-on-error: true

      - name: Verificação de tipos com MyPy
        run: |
          mypy --ignore-missing-imports .
        continue-on-error: true

  # Testes unitários Python
  python-tests:
    name: Python Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev,raspberry-pi]

      - name: Instalar dependências de teste
        run: |
          pip install pytest pytest-cov pytest-mock

      - name: Executar testes unitários
        run: |
          python -m pytest tests/ -v --cov=3dpot --cov-report=xml --cov-report=html

      - name: Upload cobertura para Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # Validação de código C++ (Arduino/ESP32)
  cpp-validation:
    name: C++ Code Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Instalar Arduino CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
          export PATH="$HOME/bin:$PATH"
          arduino-cli config init
          arduino-cli core install arduino:avr
          arduino-cli lib install "Servo"

      - name: Instalar PlatformIO
        run: |
          pip install platformio

      - name: Verificar sintaxe dos arquivos .ino
        run: |
          find codigos/ -name "*.ino" -exec arduino-cli compile --fqbn arduino:avr:uno {} \;

      - name: Verificar com PlatformIO
        run: |
          cd codigos/esp32
          pio check
        continue-on-error: true

  # Validação de modelos OpenSCAD
  openscad-validation:
    name: OpenSCAD Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Instalar OpenSCAD
        run: |
          sudo apt-get update
          sudo apt-get install -y openscad

      - name: Validar sintaxe OpenSCAD
        run: |
          find modelos-3d/ -name "*.scad" -exec openscad -c {} \;
        continue-on-error: true

      - name: Gerar STL de teste
        run: |
          find modelos-3d/ -name "*.scad" -exec bash -c 'openscad -o "${1%.scad}.stl" "$1"' _ {} \;
        continue-on-error: true

  # Teste do script de instalação
  installation-script-test:
    name: Installation Script Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Testar script de instalação
        run: |
          chmod +x setup-3dpot.sh
          # Testa sintaxe do script
          bash -n setup-3dpot.sh

  # Verificação de documentação
  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Verificar links no README
        run: |
          # Verifica se todos os arquivos referenciados existem
          if grep -q "README.md" *.md; then echo "README references found"; fi
          if grep -q "CONTRIBUTING.md" *.md; then echo "Contributing references found"; fi

      - name: Verificar estrutura de arquivos
        run: |
          # Verifica se todos os diretórios principais existem
          dirs=("codigos" "modelos-3d" "projetos" "tests")
          for dir in "${dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "Directory $dir is missing!"
              exit 1
            fi
          done

  # Build e deploy
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: [quality-checks, python-tests, cpp-validation, openscad-validation]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Gerar documentação
        run: |
          # Simula geração de documentação
          echo "Generating documentation..." > docs-build.log

      - name: Criar release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            Automated release of 3dPot project
            
            ## Changes
            - Quality checks passed
            - All tests passed
            - Code validation successful
            
            ## Files
            - Source code verified
            - Documentation updated
            - Tests coverage available
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Notificação de status
  notification:
    name: Status Notification
    runs-on: ubuntu-latest
    needs: [quality-checks, python-tests, cpp-validation, openscad-validation, documentation-check]
    if: always()
    
    steps:
      - name: Notificar status
        run: |
          if [[ "${{ needs.quality-checks.result }}" == "success" ]] && 
             [[ "${{ needs.python-tests.result }}" == "success" ]] &&
             [[ "${{ needs.cpp-validation.result }}" == "success" ]] &&
             [[ "${{ needs.openscad-validation.result }}" == "success" ]]; then
            echo "✅ All checks passed!"
          else
            echo "❌ Some checks failed!"
            exit 1
          fi

  # Limpeza e manutenção
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    if: always()
    needs: [notification]
    
    steps:
      - name: Cleanup temporary files
        run: |
          echo "Cleaning up temporary files..."
          find . -name "*.pyc" -delete
          find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true