name: 3dPot Python Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential
          
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install pytest pytest-cov pytest-xdist pytest-asyncio pytest-mock
          # Install project dependencies if available
          if [ -f pyproject.toml ]; then
            pip install -e .[dev] || echo "No dev dependencies found"
          elif [ -f requirements.txt ]; then
            pip install -r requirements.txt || echo "Requirements file not found"
          fi
          
      - name: Run unit tests with coverage
        run: |
          if [ -d tests/unit ] && [ "$(ls -A tests/unit 2>/dev/null)" ]; then
            echo "Running unit tests with coverage..."
            pytest tests/unit/ -v \
              --cov=backend/services \
              --cov=backend/core \
              --cov-report=xml \
              --cov-report=html \
              --cov-report=term-missing \
              --cov-fail-under=70 \
              --junitxml=pytest-results-unit.xml \
              --maxfail=10 \
              --tb=short
          else
            echo "No unit tests found - skipping"
          fi
      
      - name: Run integration tests
        continue-on-error: true
        run: |
          if [ -d tests/integration ] && [ "$(ls -A tests/integration 2>/dev/null)" ]; then
            echo "Running integration tests..."
            pytest tests/integration/ -v \
              --maxfail=5 \
              --tb=short
          else
            echo "No integration tests found - skipping"
          fi
          
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-python${{ matrix.python-version }}
          fail_ci_if_error: false
          
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-python${{ matrix.python-version }}
          path: |
            pytest-results-*.xml
            coverage.xml
            htmlcov/
            
      - name: Check coverage threshold
        if: matrix.python-version == '3.11'
        run: |
          if [ -f coverage.xml ]; then
            echo "üìä Coverage report generated successfully"
            echo "Threshold: 70% (configured in pytest step)"
          fi
  
  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety pip-audit
          
      - name: Run Bandit security scan
        continue-on-error: true
        run: |
          echo "üîí Running Bandit security scan on Python code..."
          bandit -r backend/ -f json -o bandit-report.json || true
          bandit -r backend/ -f txt || echo "‚ö†Ô∏è  Bandit found potential security issues"
          
      - name: Run Safety check on dependencies
        continue-on-error: true
        run: |
          echo "üîí Checking dependencies for known vulnerabilities..."
          if [ -f requirements.txt ]; then
            safety check --file requirements.txt --json > safety-report.json || true
            safety check --file requirements.txt || echo "‚ö†Ô∏è  Safety found vulnerable dependencies"
          fi
          
      - name: Run pip-audit
        continue-on-error: true
        run: |
          echo "üîí Running pip-audit on installed packages..."
          if [ -f requirements.txt ]; then
            pip-audit --requirement requirements.txt --format json > pip-audit-report.json || true
            pip-audit --requirement requirements.txt || echo "‚ö†Ô∏è  pip-audit found vulnerabilities"
          fi
          
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
            pip-audit-report.json
  
  e2e-tests:
    name: E2E Tests (Optional)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true  # Don't fail CI if E2E tests fail
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-mock
          pip install fastapi httpx  # Required for E2E tests
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || true
          fi
          
      - name: Run E2E tests
        continue-on-error: true
        run: |
          if [ -d tests/e2e ] && [ "$(ls -A tests/e2e 2>/dev/null)" ]; then
            echo "Running E2E tests..."
            echo "‚ö†Ô∏è  Note: Many E2E tests may be skipped if full environment is not configured"
            pytest tests/e2e/ -v \
              --tb=short \
              --junitxml=pytest-results-e2e.xml
          else
            echo "No E2E tests found - skipping"
          fi
          
      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: pytest-results-e2e.xml
