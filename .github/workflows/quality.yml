name: Code Quality and Linting

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Permite execução manual

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Verificação de segurança
  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Instalar ferramentas de segurança
        run: |
          pip install safety bandit semgrep

      - name: Verificar dependências com Safety
        run: |
          safety check --json > safety-report.json || true
          if [ -f safety-report.json ]; then
            echo "Security report generated"
            cat safety-report.json
          fi

      - name: Análise de segurança com Bandit
        run: |
          bandit -r . -f json -o bandit-report.json || true
          if [ -f bandit-report.json ]; then
            echo "Bandit security report generated"
            cat bandit-report.json
          fi

      - name: Análise com Semgrep
        run: |
          semgrep --config=auto --json --output=semgrep-report.json . || true
          if [ -f semgrep-report.json ]; then
            echo "Semgrep report generated"
          fi

  # Verificação de código Python
  python-quality:
    name: Python Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Instalar ferramentas de qualidade
        run: |
          pip install black flake8 isort mypy pylint radon

      - name: Verificar formatação com Black
        run: |
          black --line-length 88 --check --diff .

      - name: Verificar imports com isort
        run: |
          isort --check-only --profile black .

      - name: Linting com Flake8
        run: |
          flake8 . --count --statistics --max-line-length=88 --extend-ignore=E203,W503

      - name: Verificação de tipos com MyPy
        run: |
          mypy --ignore-missing-imports --show-error-codes .

      - name: Análise com Pylint
        run: |
          pylint --rcfile=.pylintrc . || true

      - name: Análise de complexidade com Radon
        run: |
          radon cc . -a
          radon mi .
          radon cc codigos/ -s

  # Verificação de código C++/Arduino
  cpp-quality:
    name: C++ Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Instalar clang-tidy e cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy cppcheck

      - name: Análise estática com cppcheck
        run: |
          find codigos/ -name "*.ino" -exec cppcheck --enable=all --xml-version=2 {} \;

      - name: Verificação com clang-tidy
        run: |
          # Cria arquivos temporários para análise
          find codigos/ -name "*.ino" -exec sh -c 'clang-tidy "$1" 2>/dev/null || echo "clang-tindy not available for Arduino files"' _ {} \;

  # Verificação de documentação
  documentation-quality:
    name: Documentation Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Verificar estrutura de documentação
        run: |
          # Verifica se documentos principais existem
          required_docs=("README.md" "CONTRIBUTING.md" "CODE_OF_CONDUCT.md" "LICENSE" "CHANGELOG.md" "TODO.md")
          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "Missing required document: $doc"
              exit 1
            fi
          done

      - name: Verificar qualidade do README
        run: |
          # Verifica se README tem seções essenciais
          if grep -q "##" README.md; then
            echo "README has proper headings"
          else
            echo "README missing proper headings"
            exit 1
          fi

      - name: Verificar badges de status
        run: |
          # Verifica se README tem badges ou sugere adicioná-los
          if grep -q "!\[.*\]" README.md || grep -q "badge" README.md; then
            echo "README has status badges"
          else
            echo "WARNING: README could benefit from status badges"
          fi

      - name: Verificar formatação Markdown
        run: |
          # Instala e usa uma ferramenta de validação MD
          npm install -g markdownlint-cli || true
          markdownlint *.md || true

  # Análise de estrutura do projeto
  project-structure:
    name: Project Structure Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Verificar estrutura de diretórios
        run: |
          # Verifica se estrutura principal está presente
          expected_structure=(
            "codigos"
            "codigos/esp32"
            "codigos/arduino"
            "codigos/raspberry-pi"
            "modelos-3d"
            "modelos-3d/esp32-projetos"
            "modelos-3d/arduino-projetos"
            "projetos"
            "projetos/esp32"
            "projetos/arduino"
            "projetos/raspberry-pi"
            "tests"
            "tests/unit"
          )
          
          for dir in "${expected_structure[@]}"; do
            if [ ! -e "$dir" ]; then
              echo "Missing expected directory: $dir"
              exit 1
            else
              echo "Found expected directory: $dir"
            fi
          done

      - name: Verificar arquivos essenciais
        run: |
          # Verifica se arquivos essenciais existem
          essential_files=(
            "pyproject.toml"
            ".gitignore"
            "setup-3dpot.sh"
          )
          
          for file in "${essential_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Missing essential file: $file"
              exit 1
            else
              echo "Found essential file: $file"
            fi
          done

      - name: Verificar conteúdo dos diretórios de código
        run: |
          # Verifica se diretórios de código não estão vazios
          code_dirs=("codigos/esp32" "codigos/arduino" "codigos/raspberry-pi")
          
          for dir in "${code_dirs[@]}"; do
            file_count=$(find "$dir" -type f | wc -l)
            echo "Files in $dir: $file_count"
            if [ "$file_count" -eq 0 ]; then
              echo "WARNING: $dir appears to be empty"
            fi
          done

  # Verificação de compatibilidade
  compatibility-check:
    name: Compatibility Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Verificar sintaxe Python
        run: |
          python -m py_compile $(find . -name "*.py" -not -path "./tests/*") || exit 1

      - name: Testar importação de módulos
        run: |
          python -c "import sys; sys.path.insert(0, '.'); from tests.unit.test_raspberry_pi.test_qc_station import *; print('Import successful')" || true

  # Relatório final de qualidade
  quality-report:
    name: Quality Report
    runs-on: ubuntu-latest
    needs: [security-scan, python-quality, cpp-quality, documentation-quality, project-structure, compatibility-check]
    if: always()
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Gerar relatório de qualidade
        run: |
          echo "# Relatório de Qualidade - 3dPot" > quality-report.md
          echo "" >> quality-report.md
          echo "**Data:** $(date)" >> quality-report.md
          echo "**Commit:** ${{ github.sha }}" >> quality-report.md
          echo "**Branch:** ${{ github.ref_name }}" >> quality-report.md
          echo "" >> quality-report.md
          
          # Status dos jobs
          echo "## Status dos Verificações" >> quality-report.md
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> quality-report.md
          echo "- Python Quality: ${{ needs.python-quality.result }}" >> quality-report.md
          echo "- C++ Quality: ${{ needs.cpp-quality.result }}" >> quality-report.md
          echo "- Documentation: ${{ needs.documentation-quality.result }}" >> quality-report.md
          echo "- Project Structure: ${{ needs.project-structure.result }}" >> quality-report.md
          echo "- Compatibility: ${{ needs.compatibility-check.result }}" >> quality-report.md

      - name: Upload relatório
        uses: actions/upload-artifact@v3
        with:
          name: quality-report
          path: quality-report.md

      - name: Comment PR (se aplicável)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('quality-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });